openapi: 3.0.0
info:
  title: Bangumi Fetcher Service API
  description: Fetcher 服務 API 規格 - 用於爬取和解析動畫 RSS 源
  version: 0.2.0
  contact:
    name: Bangumi Project
  license:
    name: MIT

servers:
  - url: http://fetcher-mikanani:8001
    description: Mikanani Fetcher (Docker)
  - url: http://localhost:8001
    description: Fetcher 本地開發

tags:
  - name: Health
    description: 服務健康檢查
  - name: Fetch
    description: RSS 爬取功能
  - name: Ownership
    description: URL 歸屬檢查

paths:
  /health:
    get:
      tags:
        - Health
      summary: 健康檢查
      description: 檢查 Fetcher 服務是否正常運行
      operationId: getHealth
      responses:
        '200':
          description: 服務正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

  /fetch:
    post:
      tags:
        - Fetch
      summary: 觸發 RSS 爬取
      description: |
        觸發 RSS 爬取任務。此端點為非同步操作：
        1. 立即回傳 202 Accepted
        2. 在背景執行爬取任務
        3. 完成後回呼到指定的 callback_url
      operationId: triggerFetch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FetchTriggerRequest'
            examples:
              mikanani:
                summary: Mikanani RSS 源
                value:
                  subscription_id: 123
                  rss_url: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
                  callback_url: "http://core-service:8000/raw-fetcher-results"
      responses:
        '202':
          description: 爬取任務已接受
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FetchTriggerResponse'
              examples:
                accepted:
                  summary: 任務已接受
                  value:
                    accepted: true
                    message: "Fetch task accepted for subscription 123"
        '400':
          description: 請求格式錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /can-handle-subscription:
    post:
      tags:
        - Ownership
      summary: 檢查 URL 歸屬
      description: |
        檢查此 Fetcher 是否可以處理指定的訂閱 URL。
        Core Service 使用此端點來路由訂閱到正確的 Fetcher。
      operationId: canHandleSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CanHandleRequest'
            examples:
              mikanani:
                summary: Mikanani RSS URL
                value:
                  source_url: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
                  source_type: "rss"
      responses:
        '200':
          description: 可以處理此 URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanHandleResponse'
              examples:
                canHandle:
                  value:
                    can_handle: true
        '204':
          description: 無法處理此 URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanHandleResponse'
              examples:
                cannotHandle:
                  value:
                    can_handle: false

components:
  schemas:
    FetchTriggerRequest:
      type: object
      required:
        - subscription_id
        - rss_url
        - callback_url
      properties:
        subscription_id:
          type: integer
          description: 訂閱 ID
          example: 123
        rss_url:
          type: string
          format: uri
          description: RSS 源的完整 URL
          example: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
        callback_url:
          type: string
          format: uri
          description: 爬取完成後的回呼 URL
          example: "http://core-service:8000/raw-fetcher-results"

    FetchTriggerResponse:
      type: object
      required:
        - accepted
        - message
      properties:
        accepted:
          type: boolean
          description: 任務是否被接受
          example: true
        message:
          type: string
          description: 狀態訊息
          example: "Fetch task accepted for subscription 123"

    CanHandleRequest:
      type: object
      required:
        - source_url
        - source_type
      properties:
        source_url:
          type: string
          format: uri
          description: 訂閱來源 URL
          example: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
        source_type:
          type: string
          description: 訂閱類型（例如 "rss"）
          example: "rss"

    CanHandleResponse:
      type: object
      required:
        - can_handle
      properties:
        can_handle:
          type: boolean
          description: 是否可以處理此訂閱
          example: true

    ErrorResponse:
      type: object
      required:
        - status
        - error
      properties:
        status:
          type: string
          enum: [error]
          example: "error"
        error:
          type: string
          description: 錯誤詳細信息
          example: "Invalid request format"

  responses:
    HealthCheck:
      description: 服務健康檢查響應
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "ok"

    FetchAccepted:
      description: RSS 爬取任務已接受
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/FetchTriggerResponse'

    BadRequest:
      description: 請求格式錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
