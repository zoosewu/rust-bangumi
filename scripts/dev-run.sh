#!/bin/bash
# é–‹ç™¼ç’°å¢ƒå•Ÿå‹•è…³æœ¬
# åŠŸèƒ½ï¼šè‡ªå‹•è¨­å®šç’°å¢ƒã€åŸ·è¡Œé·ç§»ã€å•Ÿå‹•æœå‹™

set -e

echo "ğŸš€ Bangumi é–‹ç™¼ç’°å¢ƒå•Ÿå‹•"
echo ""

# ============================================================================
# ç¬¬ 1 æ­¥ï¼šè¨­å®šé–‹ç™¼ç’°å¢ƒ
# ============================================================================

cd "$(dirname "$0")" || exit 1
. ./setup-dev-env.sh

# ============================================================================
# ç¬¬ 2 æ­¥ï¼šæª¢æŸ¥ PostgreSQL é€£æ¥
# ============================================================================

echo "â³ æª¢æŸ¥ PostgreSQL é€£æ¥..."

MAX_ATTEMPTS=30
ATTEMPT=0

while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
    if psql "$DATABASE_URL" -c "SELECT 1" >/dev/null 2>&1; then
        echo "âœ“ PostgreSQL é€£æ¥æˆåŠŸ"
        break
    fi
    
    ATTEMPT=$((ATTEMPT + 1))
    echo "   å˜—è©¦ $ATTEMPT/$MAX_ATTEMPTS..."
    sleep 2
done

if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
    echo "âŒ ç„¡æ³•é€£æ¥åˆ° PostgreSQL"
    echo "   è«‹ç¢ºä¿ï¼š"
    echo "   1. make dev-infra å·²åŸ·è¡Œ"
    echo "   2. PostgreSQL å®¹å™¨æ­£åœ¨é‹è¡Œ"
    exit 1
fi

echo ""

# ============================================================================
# ç¬¬ 3 æ­¥ï¼šåŸ·è¡Œè³‡æ–™åº«é·ç§»
# ============================================================================

echo "ğŸ”„ åŸ·è¡Œè³‡æ–™åº«é·ç§»..."

cd /workspace/core-service

if diesel migration list 2>/dev/null | grep -q "Pending"; then
    echo "   åŸ·è¡Œå¾…åŸ·è¡Œçš„é·ç§»..."
    diesel migration run
    echo "âœ“ é·ç§»å®Œæˆ"
else
    echo "âœ“ è³‡æ–™åº«å·²æ˜¯æœ€æ–°ç‹€æ…‹"
fi

echo ""

# ============================================================================
# ç¬¬ 4 æ­¥ï¼šå•Ÿå‹•æœå‹™
# ============================================================================

echo "ğŸ¯ å•Ÿå‹• Core Service..."
echo "   è¨ªå•åœ°å€ï¼šhttp://localhost:8000"
echo "   å¥åº·æª¢æŸ¥ï¼šhttp://localhost:8000/health"
echo ""

exec cargo run --package core-service
