openapi: 3.0.0
info:
  title: Bangumi Fetcher Service API
  description: Fetcher 服務 API 規格 - 用於爬取和解析動畫 RSS 源
  version: 0.1.0
  contact:
    name: Bangumi Project
  license:
    name: MIT

servers:
  - url: http://fetcher-mikanani:8001
    description: Mikanani Fetcher (Docker)
  - url: http://localhost:8001
    description: Fetcher 本地開發

tags:
  - name: Health
    description: 服務健康檢查
  - name: Fetch
    description: RSS 爬取功能
  - name: Subscription
    description: 訂閱管理

paths:
  /health:
    get:
      tags:
        - Health
      summary: 健康檢查
      description: 檢查 Fetcher 服務是否正常運行
      operationId: getHealth
      responses:
        '200':
          description: 服務正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

  /fetch:
    post:
      tags:
        - Fetch
      summary: 爬取 RSS 源
      description: 從指定的 RSS URL 爬取動畫數據並進行解析
      operationId: fetchRss
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FetchRequest'
            examples:
              mikanani:
                summary: Mikanani RSS 源
                value:
                  rss_url: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
      responses:
        '200':
          description: 爬取成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FetchResponse'
              examples:
                success:
                  summary: 成功的爬取結果
                  value:
                    status: "success"
                    count: 42
                    error: null
        '400':
          description: 請求格式錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUrl:
                  value:
                    status: "error"
                    error: "Invalid RSS URL format"
        '500':
          description: 服務內部錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FetchResponse'
              examples:
                networkError:
                  value:
                    status: "error"
                    count: 0
                    error: "Connection refused"

  /subscribe:
    post:
      tags:
        - Subscription
      summary: 接收訂閱廣播
      description: 接收核心服務發送的訂閱廣播，建立新的 RSS 訂閱
      operationId: handleSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionBroadcastPayload'
      responses:
        '200':
          description: 訂閱已接收
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionBroadcastResponse'
        '400':
          description: 請求格式錯誤或 URL 不支持
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    FetchRequest:
      type: object
      required:
        - rss_url
      properties:
        rss_url:
          type: string
          format: uri
          description: RSS 源的完整 URL
          example: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"

    FetchResponse:
      type: object
      required:
        - status
        - count
      properties:
        status:
          type: string
          enum: [success, error]
          description: 爬取狀態
          example: "success"
        count:
          type: integer
          minimum: 0
          description: 成功解析的動畫連結數量
          example: 42
        error:
          type: string
          nullable: true
          description: 錯誤信息（成功時為 null）
          example: null

    SubscriptionBroadcastPayload:
      type: object
      required:
        - rss_url
        - service_name
      properties:
        rss_url:
          type: string
          format: uri
          description: RSS 源 URL
          example: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
        service_name:
          type: string
          description: 發送此訂閱的 Fetcher 服務名稱
          example: "mikanani"

    SubscriptionBroadcastResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: string
          description: 訂閱處理狀態
          example: "received"
        message:
          type: string
          description: 狀態消息
          example: "Subscription received for https://mikanani.me/RSS/Bangumi?bangumiId=3215"

    ErrorResponse:
      type: object
      required:
        - status
        - error
      properties:
        status:
          type: string
          enum: [error]
          example: "error"
        error:
          type: string
          description: 錯誤詳細信息
          example: "Connection refused"

  responses:
    HealthCheck:
      description: 服務健康檢查響應
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: "ok"

    FetchSuccess:
      description: RSS 爬取成功
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/FetchResponse'

    FetchError:
      description: RSS 爬取失敗
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/FetchResponse'

    SubscriptionReceived:
      description: 訂閱已接收
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubscriptionBroadcastResponse'

    BadRequest:
      description: 請求格式錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalError:
      description: 服務內部錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
