version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: bangumi-postgres
    environment:
      POSTGRES_DB: bangumi
      POSTGRES_USER: bangumi
      POSTGRES_PASSWORD: bangumi_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - bangumi-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bangumi -d bangumi"]
      interval: 10s
      timeout: 5s
      retries: 5

  core-service:
    build:
      context: .
      dockerfile: Dockerfile.core
    container_name: bangumi-core
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://bangumi:bangumi_password@postgres:5432/bangumi
      RUST_LOG: core_service=debug
      RUST_BACKTRACE: 1
    ports:
      - "8000:8000"
    networks:
      - bangumi-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  fetcher-mikanani:
    build:
      context: .
      dockerfile: Dockerfile.fetcher-mikanani
    container_name: bangumi-fetcher-mikanani
    depends_on:
      core-service:
        condition: service_healthy
    environment:
      CORE_SERVICE_URL: http://core-service:8000
      RUST_LOG: fetcher_mikanani=debug
      RUST_BACKTRACE: 1
    ports:
      - "8001:8001"
    networks:
      - bangumi-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  downloader-qbittorrent:
    build:
      context: .
      dockerfile: Dockerfile.downloader-qbittorrent
    container_name: bangumi-downloader-qbittorrent
    depends_on:
      core-service:
        condition: service_healthy
    environment:
      CORE_SERVICE_URL: http://core-service:8000
      QBITTORRENT_URL: http://qbittorrent:8080
      RUST_LOG: downloader_qbittorrent=debug
      RUST_BACKTRACE: 1
    ports:
      - "8002:8002"
    networks:
      - bangumi-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  viewer-jellyfin:
    build:
      context: .
      dockerfile: Dockerfile.viewer-jellyfin
    container_name: bangumi-viewer-jellyfin
    depends_on:
      core-service:
        condition: service_healthy
    environment:
      CORE_SERVICE_URL: http://core-service:8000
      RUST_LOG: viewer_jellyfin=debug
      RUST_BACKTRACE: 1
    ports:
      - "8003:8003"
    volumes:
      - media_output:/media/output
    networks:
      - bangumi-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 可選：qBittorrent 容器（用於開發）
  # qbittorrent:
  #   image: qbittorrent:latest
  #   container_name: bangumi-qbittorrent
  #   environment:
  #     WEBUI_PORT: 8080
  #   ports:
  #     - "6881:6881"
  #     - "6881:6881/udp"
  #     - "8080:8080"
  #   volumes:
  #     - downloads:/downloads
  #   networks:
  #     - bangumi-network

volumes:
  postgres_data:
  media_output:

networks:
  bangumi-network:
    driver: bridge
