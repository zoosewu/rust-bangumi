openapi: 3.0.0
info:
  title: Bangumi Mikanani Fetcher API
  description: Mikanani 特化 Fetcher 服務 API 規格 - 用於爬取和解析 Mikanani 動畫 RSS 源
  version: 0.2.0
  contact:
    name: Bangumi Project
    url: https://mikanani.me
  license:
    name: MIT

servers:
  - url: http://fetcher-mikanani:8001
    description: Mikanani Fetcher (Docker 生產環境)
  - url: http://localhost:8001
    description: Mikanani Fetcher (本地開發環境)

x-logo:
  url: https://mikanani.me/favicon.ico

tags:
  - name: Health
    description: 服務健康檢查和狀態監控
  - name: Fetch
    description: RSS 爬取功能 - Mikanani 專用
  - name: Ownership
    description: URL 歸屬檢查

paths:
  /health:
    get:
      tags:
        - Health
      summary: 健康檢查
      description: 檢查 Mikanani Fetcher 服務是否正常運行
      operationId: getHealth
      responses:
        '200':
          description: 服務正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'

  /fetch:
    post:
      tags:
        - Fetch
      summary: 觸發 Mikanani RSS 爬取
      description: |
        觸發 Mikanani RSS 爬取任務。此端點為非同步操作：
        1. 立即回傳 202 Accepted
        2. 在背景執行爬取任務
        3. 完成後回呼到指定的 callback_url

        ## 特性
        - 支援 Mikanani RSS 格式解析
        - 指數退避重試（最多3次）
        - 自動提取原始 RSS 項目資料

        ## 支持的 Mikanani URL 格式
        - `https://mikanani.me/RSS/Bangumi?bangumiId=<id>`
        - `https://mikanani.me/RSS/Bangumi?status=2&subgroupid=<id>`
      operationId: triggerMikananiFetch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FetchTriggerRequest'
            examples:
              byBangumiId:
                summary: 使用 Bangumi ID 爬取
                value:
                  subscription_id: 123
                  rss_url: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
                  callback_url: "http://core-service:8000/raw-fetcher-results"
              bySubgroup:
                summary: 使用字幕組 ID 爬取
                value:
                  subscription_id: 456
                  rss_url: "https://mikanani.me/RSS/Bangumi?status=2&subgroupid=583"
                  callback_url: "http://core-service:8000/raw-fetcher-results"
      responses:
        '202':
          description: 爬取任務已接受
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FetchTriggerResponse'
              examples:
                accepted:
                  summary: 任務已接受
                  value:
                    accepted: true
                    message: "Fetch task accepted for subscription 123"
        '400':
          description: 請求格式錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUrl:
                  value:
                    status: "error"
                    error: "Invalid request format"

  /can-handle-subscription:
    post:
      tags:
        - Ownership
      summary: 檢查 URL 歸屬
      description: |
        檢查此 Fetcher 是否可以處理指定的訂閱 URL。

        Mikanani Fetcher 會驗證：
        - URL 是否來自 mikanani.me 域名
        - source_type 是否為 "rss"
      operationId: canHandleMikananiSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CanHandleRequest'
            examples:
              mikananiUrl:
                summary: Mikanani RSS URL
                value:
                  source_url: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
                  source_type: "rss"
              otherUrl:
                summary: 非 Mikanani URL
                value:
                  source_url: "https://example.com/rss"
                  source_type: "rss"
      responses:
        '200':
          description: 可以處理此 URL（URL 包含 mikanani.me 且類型為 rss）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanHandleResponse'
              examples:
                canHandle:
                  value:
                    can_handle: true
        '204':
          description: 無法處理此 URL（URL 不是 mikanani.me 或類型不是 rss）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanHandleResponse'
              examples:
                cannotHandle:
                  value:
                    can_handle: false

components:
  schemas:
    FetchTriggerRequest:
      type: object
      required:
        - subscription_id
        - rss_url
        - callback_url
      properties:
        subscription_id:
          type: integer
          description: 訂閱 ID
          example: 123
        rss_url:
          type: string
          format: uri
          pattern: '^https?://mikanani\.me/RSS/.*'
          description: Mikanani RSS 源的完整 URL
          example: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
        callback_url:
          type: string
          format: uri
          description: 爬取完成後的回呼 URL
          example: "http://core-service:8000/raw-fetcher-results"

    FetchTriggerResponse:
      type: object
      required:
        - accepted
        - message
      properties:
        accepted:
          type: boolean
          description: 任務是否被接受
          example: true
        message:
          type: string
          description: 狀態訊息
          example: "Fetch task accepted for subscription 123"

    CanHandleRequest:
      type: object
      required:
        - source_url
        - source_type
      properties:
        source_url:
          type: string
          format: uri
          description: 訂閱來源 URL
          example: "https://mikanani.me/RSS/Bangumi?bangumiId=3215"
        source_type:
          type: string
          description: 訂閱類型
          example: "rss"

    CanHandleResponse:
      type: object
      required:
        - can_handle
      properties:
        can_handle:
          type: boolean
          description: 是否可以處理此訂閱
          example: true

    HealthCheckResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [ok]
          description: 服務健康狀態
          example: "ok"

    ErrorResponse:
      type: object
      required:
        - status
        - error
      properties:
        status:
          type: string
          enum: [error]
          example: "error"
        error:
          type: string
          description: 錯誤詳細信息
          example: "Invalid request format"

  responses:
    HealthCheckResponse:
      description: 服務健康檢查響應
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/HealthCheckResponse'

    FetchAccepted:
      description: RSS 爬取任務已接受
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/FetchTriggerResponse'

    BadRequest:
      description: 請求格式錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
